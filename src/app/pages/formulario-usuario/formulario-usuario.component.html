<app-page-header
  [titulo]="'Nuevo usuario'"
  [icono]="'fas fa-user-plus'"
  [breadcrumbs]="breads"
>
</app-page-header>

<!--Contenido de la página-->
<section class="content">
  <div class="container-fluid">

    <ngx-loading-bar
      color="#339942"
      height="2"
      animationTime="0.8"
    ></ngx-loading-bar>

    <div class="col-md-12">
      <div class="row align-items-center">
        <div class="col-md-12">

          <!-- Formulario de registro -->
          <div class="card card-primary" *ngIf="!isEdit">
            <div class="card-header">
              <h3 class="card-title">Crear nuevo usuario</h3>
              <div class="card-tools"></div>
            </div>
            <div class="card-body">
              <form
                role="form"
                #usuarioForm="ngForm"
                (ngSubmit)="onSubmit(usuarioForm)"
              >
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="usuario">Nombre de usuario:</label>
                      <div class="input-group mb-3">
                        <input
                          type="text"
                          #nombre="ngModel"
                          [(ngModel)]="usuario.usuario"
                          name="nombreUsuario"
                          class="form-control"
                          placeholder="Usuario"
                          required
                          [ngClass]="{
                            'is-invalid': !nombre.valid && nombre.touched
                          }"
                        />
                        <div class="input-group-append">
                          <div class="input-group-text">
                            <span class="fas fa-user"></span>
                          </div>
                        </div>
                      </div>
                      <small
                        class="text-danger"
                        *ngIf="!nombre.valid && nombre.touched"
                      >
                        Campo requerido
                      </small>
                    </div>
                  </div>
                  <!--<div class="col-md-2"></div>-->
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="rol">Rol de usuario:</label>
                      <div class="input-group mb-3">
                        <select
                          name="rolUsuario"
                          class="form-control"
                          [(ngModel)]="usuario.rol"
                          #rol="ngModel"
                          [ngClass]="{
                            'is-invalid': !rol.valid && rol.touched
                          }"
                          required
                        >
                          <option selected value="Administrador">Administrador</option>
                          <option value="Enfermero">Enfermer@</option>
                          <option value="Laboratorista">Laboratorista</option>
                          <option value="Recepcionista">Recepcionista</option>
                        </select>
                        <div class="input-group-append">
                          <div class="input-group-text">
                            <span class="fas fa-user-cog"></span>
                          </div>
                        </div>
                      </div>
                      <small
                        class="text-danger"
                        *ngIf="rol.value == '' && rol.touched"
                      >
                        Campo requerido
                      </small>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="password">Contraseña: </label>
                      <div class="input-group mb-3">
                        <input
                          required
                          name="contra"
                          #contraUsuario="ngModel"
                          type="{{passwordTypeInput}}"
                          class="form-control"
                          placeholder="Contraseña"
                          [(ngModel)]="usuario.pass"
                          (ngModelChange)="passLgth()"
                          [ngClass]="{
                            'is-invalid':
                              !contraUsuario.valid && contraUsuario.touched
                          }"
                        />
                        <div class="input-group-append">
                          <button class="input-group-text" type="button" (click)="mostrarPassword()">
                            <span class="fa fa-eye-slash icon"></span>
                          </button>
                        </div>
                      </div>
                      <small class="text-danger" *ngIf="minPass">
                        Debe contener un mínimo de 8 caractéres
                      </small>
                    </div>
                  </div>
                  <!--<div class="col-md-2"></div>-->
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="password">Confirmar contraseña: </label>
                      <div class="input-group mb-3">
                        <input
                          name="passwordCofirm"
                          #passwor="ngModel"
                          type="password"
                          class="form-control"
                          placeholder="Contraseña"
                          [(ngModel)]="pas"
                          (ngModelChange)="validarPass()"
                          [ngClass]="{
                            'is-invalid': !passwor.valid && passwor.touched
                          }"
                        />

                        <div class="input-group-append">
                          <div class="input-group-text">
                            <span class="fas fa-lock"></span>
                          </div>
                        </div>
                      </div>
                      <small class="text-danger" *ngIf="valPass == false">
                        Las contraseñas no coinciden
                      </small>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <!-- /.col -->
                  <div class="col-md-9"></div>
                  <div class="col-md-3">
                    <button
                      type="submit"
                      class="btn btn-primary mr-3"
                      [disabled]="usuarioForm.invalid || minPass || !valPass"
                    >
                      Registrar usuario
                    </button>
                    <button
                      type="reset"
                      class="btn btn-secondary"
                      [ngStyle]="{ display: 'space-between' }"
                    >
                      Cancelar
                    </button>
                  </div>

                  <!-- /.col -->
                </div>
              </form>
            </div>
          </div>
          <!-- Fin de Formulario de registro -->

          <!-- Formulario de modificar -->
          <div class="card card-primary" *ngIf="isEdit">
            <div class="card-header">
              <h3 class="card-title">Editar registro de usuario</h3>
              <div class="card-tools"></div>
            </div>
            <div class="card-body">
              <form
                role="form"
                #usuarioForm="ngForm"
                (ngSubmit)="onSubmit2(usuarioForm)"
              >
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="usuario">Nombre de usuario:</label>
                      <div class="input-group mb-3">
                        <input
                          type="text"
                          #nombre="ngModel"
                          [(ngModel)]="usuario.usuario"
                          name="nombreUsuario"
                          class="form-control"
                          placeholder="Usuario"
                          required
                          [ngClass]="{
                            'is-invalid': !nombre.valid && nombre.touched
                          }"
                        />
                        <div class="input-group-append">
                          <div class="input-group-text">
                            <span class="fas fa-user"></span>
                          </div>
                        </div>
                      </div>
                      <small
                        class="text-danger"
                        *ngIf="!nombre.valid && nombre.touched"
                      >
                        Campo requerido
                      </small>
                    </div>
                  </div>
                  <!--<div class="col-md-2"></div>-->
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="rol">Rol de usuario:</label>
                      <div class="input-group mb-3">
                        <select
                          name="rolUsuario"
                          class="form-control"
                          [(ngModel)]="usuario.rol"
                          #rol="ngModel"
                          [ngClass]="{
                            'is-invalid': !rol.valid && rol.touched
                          }"
                          required
                        >
                          <option value=""></option>
                          <option value="Administrador">Administrador</option>
                          <option value="Enfermero">Enfermer@</option>
                          <option value="Laboratorista">Laboratorista</option>
                          <option value="Recepcionista">Recepcionista</option>
                        </select>
                        <div class="input-group-append">
                          <div class="input-group-text">
                            <span class="fas fa-user-cog"></span>
                          </div>
                        </div>
                      </div>
                      <small
                        class="text-danger"
                        *ngIf="rol.value == '' && rol.touched"
                      >
                        Campo requerido
                      </small>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="password">Contraseña: </label>
                      <div class="input-group mb-3">
                        <input
                          required
                          name="contra"
                          #contraUsuario="ngModel"
                          type="{{passwordTypeInput}}"
                          class="form-control"
                          placeholder="Contraseña"
                          [(ngModel)]="usuario.pass"
                          (ngModelChange)="passLgth()"
                          [ngClass]="{
                            'is-invalid':
                              !contraUsuario.valid && contraUsuario.touched
                          }"
                        />
                        <div class="input-group-append">
                          <button class="input-group-text" type="button" (click)="mostrarPassword()">
                            <span class="fa fa-eye-slash icon"></span>
                          </button>
                        </div>
                      </div>
                      <small class="text-danger" *ngIf="minPass">
                        Debe contener un mínimo de 8 caractéres
                      </small>
                    </div>
                  </div>
                  <!--<div class="col-md-2"></div>-->
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="password">Confirmar contraseña: </label>
                      <div class="input-group mb-3">
                        <input
                          name="passwordCofirm"
                          #passwor="ngModel"
                          type="password"
                          class="form-control"
                          placeholder="Contraseña"
                          [(ngModel)]="pas"
                          (ngModelChange)="validarPass()"
                          [ngClass]="{
                            'is-invalid': !passwor.valid && passwor.touched
                          }"
                        />

                        <div class="input-group-append">
                          <div class="input-group-text">
                            <span class="fas fa-lock"></span>
                          </div>
                        </div>
                      </div>
                      <small class="text-danger" *ngIf="valPass == false">
                        Las contraseñas no coinciden
                      </small>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <!-- /.col -->
                  <div class="col-md-9"></div>
                  <div class="col-md-3">
                    <button
                      type="submit"
                      class="btn btn-primary mr-3"
                      [disabled]="usuarioForm.invalid || minPass || !valPass"
                    >
                      Modificar usuario
                    </button>
                    <button
                      type="reset"
                      class="btn btn-secondary"
                      [ngStyle]="{ display: 'space-between' }"
                    >
                      Cancelar
                    </button>
                  </div>

                  <!-- /.col -->
                </div>
              </form>
            </div>
          </div>
          <!-- Fin de Formulario de modificar -->

        </div><!-- Fin de col-md-12 interno del formulario-->

       
      </div> <!--  Fin row align-items-center -->

      <!-- Tabla de registros -->
      <div class="col-md-12">
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">Usuarios registrados</h3>
            <div class="card-tools"></div>
            <!-- card tools -->
          </div>
          <!-- /.card-header -->

          <div class="card-body">
            <table
              datatable
              [dtOptions]="dtOptions"
              [dtTrigger]="dtTrigger"
              class="row-border hover table table-bordered table-striped align-right"
            >
              <thead>
                <tr>
                  <th>Nombre de usuario</th>
                  <th>Rol de usuario</th>
                  <th>Fecha de registro</th>
                  <th>Editar</th>
                  <th>Eliminar</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of usuarios let i = index">
                  <td>{{ user.usuario }}</td>
                  <td>{{ user.rol }}</td>
                  <td>{{ user.fechaRegistro | fechaFormat }}</td>
                  <td>
                    <button
                      type="button"
                      (click)="llenarCampos(user._id)"
                      class="btn btn-block btn-default"
                    >
                      <a style="color: gray;">
                        <i class="fa fa-wrench"></i>
                      </a>
                    </button>
                  </td>
                  <td>
                    <button
                      type="button"
                      (click)="eliminarUsuario(user._id,i)"
                      class="btn btn-block btn-default"
                    >
                      <a style="color: gray;">
                        <i class="fa fa-user-times"></i>
                      </a>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- /.card-body -->
        </div>
        <!-- /.card -->
      </div>
      <!-- Fin de Tabla de registros -->

    </div>
    <!-- Div col-md-12-->
  </div>
  <!--Fin del container-fluid-->
</section>


 <!-- Sweet alerts -->
      <!-- Sweet Confirm Delete -->
      <swal
        #redireccionSwalDel
        title="¿Estás seguro?"
        text="El usuario seleccionado será eliminado"
        icon="warning"
        [showCancelButton]="true"
        confirmButtonText="Sí!"
        cancelButtonText="No!"
        confirmButtonColor="#3085d6"
        cancelButtonColor="#bbbbbb"
        [focusCancel]="true"
      >
      </swal>

      <!-- Sweet error -->

      <swal
        #errorSwalDel
        title="Error!"
        text="No se pudo eliminar el registro"
        icon="error"
        confirmButtonText="Ok"
        confirmButtonColor="#3085d6"
        [focusConfirm]="true"
        (confirm)="getUsuarios()"
      >
      </swal>

        <!-- Sweet Confirm Registro -->
        <swal
          #redireccionSwal
          title="Usuario registrado!"
          text="El usuario ha sido registrado con éxito"
          icon="success"
          [showCancelButton]="false"
          confirmButtonText="Ok!"
          cancelButtonText="No!"
          confirmButtonColor="#3085d6"
          cancelButtonColor="#bbbbbb"
          [focusConfirm]="true"
          (confirm)="refrescarTabla()"
        >
        </swal>

        <!-- Sweet error -->

        <swal
          #errorSwal
          title="Error!"
          text="No se pudo realizar el registro"
          icon="error"
          confirmButtonText="Ok"
          confirmButtonColor="#3085d6"
          [focusConfirm]="true"
        >
        </swal>

        <swal
          #redireccionSwalMod
          title="Usuario modificado!"
          text="El usuario ha sido modificado con éxito"
          icon="success"
          [showCancelButton]="false"
          confirmButtonText="Ok!"
          cancelButtonText="No!"
          confirmButtonColor="#3085d6"
          cancelButtonColor="#bbbbbb"
          [focusCancel]="true"
          (confirm)="refrescarTabla()"
        >
        </swal>

        <!-- Sweet error en modificación -->

        <swal
          #errorSwalMod
          title="Error!"
          text="No se pudo modificar el registro"
          icon="error"
          confirmButtonText="Ok"
          confirmButtonColor="#3085d6"
          [focusConfirm]="true"
        >
        </swal>